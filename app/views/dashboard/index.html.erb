<% @switch_state_changed = false %>
<% @dimmer_state_changed = false %>
<script src="https://cdn.firebase.com/js/client/1.1.3/firebase.js"></script>

 <style>
.dummy {
    margin-top: 100%;
}
.tile {
    vertical-align: middle;
}
.thumbnail {
    position: absolute;
    top: 15px;
    bottom: 0;
    left: 15px;
    right: 0;
    
    text-align: center;
    padding-top:calc(20% - 30px);
}

.placeholder {
    left: 5px;
    top: 15px;
    height: 140px;
    border: 1px solid grey;
    background-color: white;
    -webkit-box-shadow: 0px 0px 10px #888;
    -moz-box-shadow: 0px 0px 10px #888;
    box-shadow: 0px 0px 10px #888;
}
.placeholder:after {
            position: absolute;
            z-index: 10;
            content: " ";
            height: 120px;
            background: #f9f9f9;
            left: 0;
            right: 0;
}
.real-first-child {
    margin-left:0 !important;
}
.ui-slider-colors-demo { 
    margin-bottom: 1%; 
    width: 80%;
    margin-top: 12%;
    margin-left: 10%;
}

.switcher{

}

.widget-title {
    height: 22%;
}

.ui-slider-success { 
    margin-top: 5%;
    margin-left: 10%;
    width: 80%;
}

.temp {
  width:  40%;
  height: 45%;
  margin: auto;
  font-size: 120%;
  padding-top: 10%;


}

.device-wrapper{

  height: 30%;
  margin: auto;
  padding-top: 5%;
  
}

.handle {
  font-size: 12px;
  color: #777;
  cursor: move;
}

.motion-active {
  background-color: #00CC66;
  color: white;
}

.door-closed {
  background-color: #00CC66;
  color: white;
}

.door-open {
  background-color: #FF6600;
  color: white;
}

.door-locked {
  background-color: #00CC66;
  color: white;
}

.door-unlocked {
  background-color: #FF6600;
  color: white;
}

.widget-profile-bg-icon {
    position: absolute;
    font-size:  6em;
    color: rgba(0,0,0,.2);
    right: 30%;
    
}




</style>

           
<div class="container">

   
    
        <div id="ui-accordion">
          <% @grouped_things.each do |device_type, things| %>
               
              <div class="group">
              <% if device_type == "dimmer" %>
                <h3>Dimmers</h3>
              <% elsif device_type == "switch"%>
                <h3>Switches</h3>
              <% elsif device_type == "temperatureMeasurement"%>
                <h3>Temperatures</h3>
              <% elsif device_type == "relativeHumidityMeasurement"%>
                <h3>Humidities</h3>
              <% elsif device_type == "contact"%>
                <h3>Doors and Windows</h3>
              <% elsif device_type == "motion"%>
                <h3>Motion</h3>
              <% elsif device_type == "illuminant"%>
                <h3>Light Levels</h3>
              <% elsif device_type == "lock"%>
                <h3>Locks</h3>
              <% elsif device_type == "battery"%>
                <h3>Batteries</h3>
              <% else %>
                <h3>Unknown</h3>
              <% end %>
               
                <div class="row grid">
                  
                  <% things.each do |thing| %>
                    <% if thing.zone_id != nil %>
                  <% if thing.device_type == "dimmer" %>
                      <% dimmer = thing %>
                      <div id="thing_<%= dimmer.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                      <div class="dummy"></div>
                          <div class="thumbnail">
                              <div class="widget-title handle">
                              <h4><%= dimmer.zone.name %></h4>
                             

                              </div>
                              <% dimmer_switch = Thing.find_by(:device_type => "switch", :uid=> dimmer.uid ) %>
                              <%= form_for dimmer_switch, :remote=> true do |t| %>
                                   
                              <div class="device-wrapper">
                              <div class="switcher">
                                    
                                    <% if dimmer_switch.device_value == "on" %>
                                   
                                    <%= t.check_box(:switch_value,  {class: 'switch_'+dimmer.uid+' switch_class', :checked => true}, "on", "off") %>
                                    <% else %>
                                    <%= t.check_box(:switch_value,  {class: 'switch_'+dimmer.uid+' switch_class', :checked => false}, "on", "off") %>
                                    <% end %>
                                   
                                   </div>
                                  
                                   <%= t.text_field :switch_type, :value => "", :hidden => true %>
                            
                                   <%= t.text_field :source, :value => "remote", :hidden => true %>
                               
                                  
                              <% end %>

                              <%= form_for dimmer, :remote=> true do |t| %>
                                   <%= t.text_field :dimmer_value, :value => "", :hidden => true, :class=> "dimmer_value_"+dimmer.uid %>
                                   <%= t.text_field :source, :value => "remote", :hidden => true %>
                                   <div class="ui-slider-success ui-slider-colors-demo dimmer_<%= dimmer.uid%>"></div>
                                  
                              <% end %>
                            </div>
                            <h5><%= dimmer.label %></h5>
                          </div>
                    </div>

                    <% elsif thing.device_type == "switch" %>
                    <% switch = thing %>
                    <div id="thing_<%= switch.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                      <div class="dummy"></div>
                          <div class="thumbnail">
                              <div class="widget-title handle">
                              <h4><%= switch.zone.name %></h4>

                              </div>
                              <%= form_for switch, :remote=> true do |t| %>
                                   
                                   <div class= "temp">
                                   <div class="switcher">
                                    <% if switch.device_value == "on" %>
                                   
                                    <%= t.check_box(:switch_value,  {class: 'switch_'+switch.uid+' switch_class', :checked => true}, "on", "off") %>
                                    <% else %>
                                    <%= t.check_box(:switch_value,  {class: 'switch_'+switch.uid+' switch_class', :checked => false}, "on", "off") %>
                                    <% end %>
                                   
                                   </div>
                                  
                                   <%= t.text_field :switch_type, :value => "", :hidden => true %>
                                   <%= t.text_field :source, :value => "remote", :hidden => true %>
                                   
                                   </div>
                                    <h5><%= switch.label %></h5>
                              <% end %>
                              

                          </div>
                    </div>


                    <% elsif thing.device_type == "temperatureMeasurement" %>
                      <% temp = thing %>
                        <div id="thing_<%= temp.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>
                            <div class="thumbnail">
                                <div class="widget-title handle">
                                <h4><%= temp.zone.name %></h4>
                                </div>
                                <div class="temp temperature_<%= temp.uid %>">
                                  <%= temp.device_value %> °F
                                </div>
                                 <h5><%= temp.label %></h5>
                            </div>
                      </div>
                      <% elsif thing.device_type == "relativeHumidityMeasurement" %>
                      <% humidity = thing %>
                        <div id="thing_<%= humidity.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>
                            <div class="thumbnail">
                                <div class="widget-title handle">
                                <h4><%= humidity.zone.name %></h4>

                                </div>
                                <div class="temp humidity_<%= humidity.uid %> widget-profile-avatar">
                                  <%= humidity.device_value %> %
                                </div>
                                 <h5><%= humidity.label %></h5>
                            </div>
                      </div>
                    <% elsif thing.device_type == "motion" %>
                    <% motion = thing %>
                    <%= content_tag_for :div, motion, :class=> "tile col-md-2 col-sm-4 col-xs-6" do %>
                    
                        <div class="dummy"></div>
                            <div class="thumbnail">
                                <div class="widget-title handle">
                                <h4><%= motion.zone.name %></h4>

                                </div>
                                <div class="temp motion_<%= motion.uid %> img-circle motion-<%= motion.device_value %>">
                                 <%= motion.device_value %>
                                </div>
                                 <h5><%= motion.label %></h5>
                            </div>
                    
                    <% end %>
                    <% elsif thing.device_type == "contact" %>
                    <% contact = thing %>
                     <div id="thing_<%= contact.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>
                            <div class="thumbnail">
                                <div class="widget-title handle">
                                <h4><%= contact.zone.name %></h4>

                                </div>
                                <div class="temp contact_<%= contact.uid %> img-circle door-<%= contact.device_value %>">
                                  <%= contact.device_value %>
                                </div>
                                <h5><%= contact.label %></h5>
                            </div>
                      </div>
                    <% elsif thing.device_type == "lock" %>
                    <% lock = thing %>
                     <div id="thing_<%= lock.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>
                            <div class="thumbnail">
                                <div class="widget-title handle">
                                <h4><%= lock.zone.name %></h4>
                                  
                                </div>
                                <div class="temp lock_<%= lock.uid %> img-circle door-<% lock.device_value%> ">
                                 <%= lock.device_value %>
                                </div>
                                <h5><%= lock.label %></h5>
                            </div>
                      </div>
                     <% elsif thing.device_type == "battery" %>
                    <% battery = thing %>
                     <div id="thing_<%= battery.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>

                            <div class="thumbnail">
                              <div class="widget-profile-bg-icon"><i class="fa fa-bolt"></i></div>
                                <div class="widget-title handle">
                                
                                <h4><%= battery.zone.name %></h4>

                                </div>
                                
                                <div class="temp battery_<%= battery.uid %>">
                                  <%= battery.device_value %> %
                              </div>
                               <h5><%= battery.label %></h5>
                            </div>
                      </div>
                    <% elsif thing.device_type == "illuminant" %>
                    <% illuminant = thing %>
                     <div id="thing_<%= illuminant.id %>" class="tile col-md-2 col-sm-4 col-xs-6">
                        <div class="dummy"></div>
                            <div class="thumbnail">
                              <div class="widget-profile-bg-icon"><i class="fa lightbulb-o"></i></div>
                                <div class="widget-title handle">
                                <h4><%= illuminant.zone.name %></h4>

                                </div>
                                <div class="temp illuminant_<%= illuminant.uid %>">
                                 
                                </div>
                                 <h5><%= illuminant.label %></h5>
                            </div>
                      </div>
                    
                    <% end %>
                
              
                  <% end %>
                  <% end %>
                </div>
                </div>
              <% end %> 

        
        </div>


</div>

<script>

init.push(function () {
  $( "#ui-accordion" ).accordion({
              heightStyle: "content",
              header: "> .group > h3"

  });            
});
$('.switch_class').switcher();
   
</script>
<% @things.each do |thing| %>
<script>
 
    <% if thing.device_type == "switch" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/switch");
    <% elsif thing.device_type == "dimmer" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/level");
    <% elsif thing.device_type == "temperatureMeasurement" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/temperature");
    <% elsif thing.device_type == "relativeHumidityMeasurement" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/humidity");
    <% elsif thing.device_type == "motion" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/motion");
    <% elsif thing.device_type == "contact" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/contact");
    <% elsif thing.device_type == "illuminant" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/illuminance");
    <% elsif thing.device_type == "battery" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/battery");
    <% elsif thing.device_type == "lock" %>
    var myFirebaseRef_<%=thing.id%> = new Firebase("https://dazzling-heat-3134.firebaseio.com/events/<%= thing.uid %>/lock");
    <% end %>



    var query_<%=thing.id %> = myFirebaseRef_<%=thing.id %>.endAt().limit(1);
    query_<%=thing.id %>.on('child_added', function(snapshot) {
        var value = snapshot.val()
            if (value.name == "switch"){
                     $('.switch_'+value.device).switcher(value.value)
                     console.log("changed switch value")
                     
            
                
            }

            if (value.name == "level"){
                var levelValue = $('.dimmer_'+value.device).slider("value")
                if (value.value != levelValue){
                     $('.dimmer_'+value.device).slider("value", value.value)
                }
               
               
            }
            if (value.name == "motion"){
              $('.motion_'+value.device).html(value.value);

                if(value.value == "active"){
                  $('.motion_'+value.device).addClass("motion-"+value.value);
                }else{
                   $('.motion_'+value.device).removeClass("motion-active");
                }
              

            }
            if (value.name == "contact"){
              $('.contact_'+value.device).html(value.value);
              if(value.value == "open"){
                  $('.contact_'+value.device).removeClass("door-closed");
                  $('.contact_'+value.device).addClass("door-"+value.value);
                }else{
                   $('.contact_'+value.device).removeClass("door-open");
                   $('.contact_'+value.device).addClass("door-"+value.value);
                }

            }

            if (value.name == "lock"){
              $('.lock_'+value.device).html(value.value);
              if(value.value == "unlocked"){
                  $('.lock_'+value.device).removeClass("door-locked");
                  $('.lock_'+value.device).addClass("door-"+value.value);
                }else{
                   $('.lock_'+value.device).removeClass("door-unlocked");
                   $('.lock_'+value.device).addClass("door-"+value.value);
                }

            }

            if (value.name == "illuminance"){
              $('.illuminant_'+value.device).html(value.value+ " Lux");

            }

             if (value.name == "battery"){
              $('.battery_'+value.device).html(value.value+ " %");

            }

            if (value.name == "temperature"){
              $('.temperature_'+value.device).html(value.value+" °F");

            }

            if (value.name == "humidity"){
              $('.humidity_'+value.device).html(value.value+" %");

            }
           
        console.log(value.device+' '+value.value);
        
    });
</script>
<% end %>


<script>
    $('.switch_class').click(function() {

          var form = $(this).parents('form:first');

         
          form.submit();
         
              
    });
</script>


<script>

<% @things.where(:device_type => "dimmer").each do |dimmer| %>


var colorful_sliders_options = {
    'range': 'min',
    'min': 1,
    'max': 99,
    'value': 0,
        'stop': function(event, ui) {
            var value = $(".dimmer_<%= dimmer.uid %>").slider("value");
            $(".dimmer_value_<%= dimmer.uid %>").val(value);
            var form = $(this).parents('form:first');
            $("switch_<%= dimmer.uid %>").switcher("disable");
            form.submit();
            $("switch_<%= dimmer.uid %>").switcher("enable");
            

        }
};
$('.dimmer_<%= dimmer.uid %>').slider(colorful_sliders_options);




<% end %>
</script>


   

